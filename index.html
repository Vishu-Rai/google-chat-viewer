<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Google Chat WhatsApp Viewer</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body {
  height: 100vh;
  overflow: hidden;
  background: linear-gradient(135deg,#00c6ff,#0072ff);
  font-family: "Segoe UI", sans-serif;
}

.sidebar {
  background: white;
  height: 100vh;
  overflow-y: auto;
  border-right: 1px solid #ddd;
}

.chat-area {
  background: #e5ddd5;
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.chat-header {
  background: #075e54;
  color: white;
  padding: 10px 15px;
}

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background-image: url("https://www.transparenttextures.com/patterns/cubes.png");
}

.message-wrapper { display: flex; margin-bottom: 8px; }
.message-left { justify-content: flex-start; }
.message-right { justify-content: flex-end; }

.bubble {
  max-width: 65%;
  padding: 10px 14px;
  border-radius: 12px;
  font-size: 14px;
  box-shadow: 0 1px 1px rgba(0,0,0,0.1);
}

.bubble-left {
  background: white;
  border-radius: 0 12px 12px 12px;
}

.bubble-right {
  background: #dcf8c6;
  border-radius: 12px 0 12px 12px;
}

.sender {
  font-size: 12px;
  font-weight: bold;
  margin-bottom: 4px;
  color: #075e54;
}

.time {
  font-size: 11px;
  text-align: right;
  opacity: 0.6;
  margin-top: 4px;
}

.conversation-item {
  cursor: pointer;
  padding: 10px 15px;
  border-bottom: 1px solid #eee;
}

.conversation-item:hover { background: #f1f1f1; }

.conversation-item.active {
  background: #d9fdd3;
  font-weight: bold;
}

.highlight { background: yellow; }
</style>
</head>

<body>

<div class="container-fluid">
<div class="row">

<!-- SIDEBAR -->
<div class="col-3 sidebar p-0">

  <div class="p-3 border-bottom">

    <button class="btn btn-success w-100" onclick="loadFolder()">
      Load Google Chat Folder
    </button>

    <input class="form-control mt-2"
      id="searchConversations"
      placeholder="Search conversations..."
      oninput="filterConversations()" />

    <input class="form-control mt-2"
      id="masterSearchInput"
      placeholder="ðŸ”Ž Search in ALL chats..."
      oninput="masterSearch()" />

    <div id="masterResults"
         class="mt-2"
         style="max-height:200px; overflow-y:auto;"></div>
  </div>

  <div id="conversationList"></div>
</div>


<!-- CHAT -->
<div class="col-9 chat-area p-0">

  <div class="chat-header d-flex justify-content-between align-items-center">
    <div id="chatTitle">Select a conversation</div>
    <input class="form-control w-50"
      id="searchMessages"
      placeholder="Search inside this chat..."
      oninput="renderMessages()" />
  </div>

  <div class="messages d-flex flex-column" id="messageList"></div>
</div>

</div>
</div>

<script>

let conversations = [];
let selectedConversation = null;
let myName = null;


/* LOAD FOLDER */
async function loadFolder() {

  const dir = await window.showDirectoryPicker();
  const groupsDir = await dir.getDirectoryHandle("Groups");

  conversations = [];
  myName = null;

  for await (const entry of groupsDir.values()) {

    if (entry.kind === "directory") {

      try {
        const messagesHandle = await entry.getFileHandle("messages.json");
        const messagesFile = await messagesHandle.getFile();
        const messagesData = JSON.parse(await messagesFile.text());

        let displayName = entry.name;

        try {
          const infoHandle = await entry.getFileHandle("group_info.json");
          const infoFile = await infoHandle.getFile();
          const infoData = JSON.parse(await infoFile.text());

          if (infoData.name) displayName = infoData.name;
          else if (infoData.members)
            displayName = infoData.members.map(m => m.name).join(", ");
        } catch {}

        if (!myName && messagesData.messages.length > 0)
          myName = messagesData.messages[0]?.creator?.name;

        conversations.push({
          id: entry.name,
          name: displayName,
          messages: messagesData.messages || [],
          directoryHandle: entry
        });

      } catch {}
    }
  }

  renderConversationList();
}


/* CONVERSATION LIST */
function renderConversationList() {
  const list = document.getElementById("conversationList");
  list.innerHTML = "";

  conversations.forEach((conv, index) => {
    const div = document.createElement("div");
    div.className = "conversation-item";
    div.innerText = conv.name;
    div.onclick = () => selectConversation(index);
    list.appendChild(div);
  });
}


/* FILTER CONVERSATIONS */
function filterConversations() {
  const search = document.getElementById("searchConversations").value.toLowerCase();
  document.querySelectorAll(".conversation-item")
    .forEach((item, index) => {
      const match = conversations[index].name.toLowerCase().includes(search);
      item.style.display = match ? "block" : "none";
    });
}


/* MASTER SEARCH */
function masterSearch() {

  const query = document.getElementById("masterSearchInput").value.toLowerCase();
  const resultsDiv = document.getElementById("masterResults");
  resultsDiv.innerHTML = "";

  if (!query || query.length < 2) return;

  conversations.forEach((conv, convIndex) => {

    conv.messages.forEach((msg) => {

      if (msg.text && msg.text.toLowerCase().includes(query)) {

        const result = document.createElement("div");
        result.className = "conversation-item";
        result.style.fontSize = "13px";

        result.innerHTML = `
          <div><strong>${conv.name}</strong></div>
          <div style="opacity:0.7;">
            ${msg.text.substring(0,60)}...
          </div>
        `;

        result.onclick = () => {
          selectConversation(convIndex);
          document.getElementById("searchMessages").value = query;
          renderMessages();
          resultsDiv.innerHTML = "";
        };

        resultsDiv.appendChild(result);
      }
    });
  });
}


/* SELECT CHAT */
function selectConversation(index) {
  selectedConversation = conversations[index];
  document.getElementById("chatTitle").innerText = selectedConversation.name;

  document.querySelectorAll(".conversation-item")
    .forEach(el => el.classList.remove("active"));

  document.querySelectorAll(".conversation-item")[index]
    .classList.add("active");

  document.getElementById("searchMessages").value = "";
  renderMessages();
}


function parseGoogleDate(dateString) {
  if (!dateString) return null;
  return new Date(dateString.replace(" at ", " "));
}


/* SMART FILE FINDER */
async function getFileFromConversation(convHandle, fileName) {

  try {
    const handle = await convHandle.getFileHandle(fileName);
    return await handle.getFile();
  } catch {}

  try {
    const filesDir = await convHandle.getDirectoryHandle("Files");
    const handle = await filesDir.getFileHandle(fileName);
    return await handle.getFile();
  } catch {}

  return null;
}


/* RENDER MESSAGES (WITH MEDIA) */
async function renderMessages() {

  if (!selectedConversation) return;

  const container = document.getElementById("messageList");
  container.innerHTML = "";

  const search = document.getElementById("searchMessages").value.toLowerCase();

  const sorted = [...selectedConversation.messages]
    .sort((a,b) =>
      (parseGoogleDate(a.created_date)||0) -
      (parseGoogleDate(b.created_date)||0)
    );

  for (const msg of sorted) {

    const sender = msg.creator?.name || "Deleted User";
    const dateObj = parseGoogleDate(msg.created_date);

    const wrapper = document.createElement("div");
    wrapper.className = "message-wrapper " +
      (sender === myName ? "message-right" : "message-left");

    const bubble = document.createElement("div");
    bubble.className = "bubble " +
      (sender === myName ? "bubble-right" : "bubble-left");

    let html = "";

    if (sender !== myName)
      html += `<div class="sender">${sender}</div>`;

    if (msg.text) {

      let text = msg.text;

      if (search)
        text = text.replace(
          new RegExp(search,"gi"),
          match => `<span class="highlight">${match}</span>`
        );

      html += `<div>${text.replace(/\n/g,"<br>")}</div>`;
    }

    /* MEDIA SUPPORT */
    if (msg.attached_files) {

      for (const file of msg.attached_files) {

        const blob = await getFileFromConversation(
          selectedConversation.directoryHandle,
          file.export_name
        );

        if (!blob) continue;

        const url = URL.createObjectURL(blob);
        const ext = file.export_name.split('.').pop().toLowerCase();

        if (["jpg","jpeg","png","gif","webp"].includes(ext)) {
          html += `
            <div class="mt-2">
              <img src="${url}" 
                   class="img-fluid rounded"
                   style="max-width:300px; cursor:pointer;"
                   onclick="window.open('${url}')">
            </div>`;
        }
        else if (["mp4","webm","mov"].includes(ext)) {
          html += `
            <video controls class="mt-2" style="max-width:300px;">
              <source src="${url}">
            </video>`;
        }
        else if (ext === "pdf") {
          html += `
            <embed src="${url}" 
                   type="application/pdf"
                   width="300"
                   height="350"
                   class="mt-2"/>`;
        }
        else {
          html += `
            <div class="mt-2">
              <a href="${url}" target="_blank"
                 class="btn btn-sm btn-outline-secondary">
                 ðŸ“Ž ${file.original_name}
              </a>
            </div>`;
        }
      }
    }

    html += `<div class="time">
      ${dateObj ? dateObj.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) : ""}
    </div>`;

    bubble.innerHTML = html;
    wrapper.appendChild(bubble);
    container.appendChild(wrapper);
  }

  container.scrollTop = container.scrollHeight;
}

</script>
</body>
</html>
